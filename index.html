<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>واجهة الفهرس الليبي الموحد - نسخة الحفظ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #eceff1; margin: 0; padding: 5px; font-size: 12px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; font-size: 16px; margin: 0 0 10px 0; border-right: 3px solid #27ae60; padding-right: 8px; }
        .grid-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 8px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 2px; color: #34495e; font-size: 11px; }
        input, select, textarea { padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; height: 28px; }
        .shortcut-row { display: flex; gap: 3px; margin-top: 1px; }
        .btn-short { background: #f39c12; color: white; border: none; font-size: 9px; padding: 1px 4px; cursor: pointer; border-radius: 2px; }
        .btn-submit { background: #27ae60; color: white; border: none; padding: 8px; width: 100%; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; }
        textarea { height: 35px; resize: none; grid-column: span 3; }
        #status { margin-top: 10px; padding: 5px; border-radius: 3px; display: none; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>إضافة عنوان جديد - الفهرس الموحد</h2>
    
    <div style="background: #fff3cd; padding: 5px; margin-bottom: 10px; border: 1px solid #ffeeba; border-radius: 3px;">
        <label style="color: #856404;">مفتاح الوصول (GitHub Token):</label>
        <input type="password" id="gh_token" placeholder="أدخل التوكن الخاص بك هنا للحفظ...">
    </div>

    <div class="grid-row">
        <div class="form-group">
            <label>الرقم الدولي (ISBN)</label>
            <input type="text" id="isbn">
        </div>
        <div class="form-group" style="grid-column: span 3;">
            <label>العنوان الرئيسي</label>
            <input type="text" id="title">
        </div>
    </div>

    <div class="grid-row">
        <div class="form-group">
            <label>المؤلف الرئيسي</label>
            <input type="text" id="author">
        </div>
        <div class="form-group">
            <label>المشارك (مشرف/مترجم...)</label>
            <input type="text" id="participant">
        </div>
        <div class="form-group">
            <label>نوع المسؤولية</label>
            <select id="role">
                <option>مؤلف مشارك</option>
                <option>مشرف</option>
                <option>مراجع</option>
                <option>مترجم</option>
                <option>محقق</option>
            </select>
        </div>
        <div class="form-group">
            <label>عدد النسخ</label>
            <input type="number" id="copies" value="1">
        </div>
    </div>

    <div class="grid-row">
        <div class="form-group">
            <label>مكان النشر</label>
            <input type="text" id="place">
            <div class="shortcut-row"><button class="btn-short" onclick="document.getElementById('place').value='د.م'">د.م</button></div>
        </div>
        <div class="form-group">
            <label>الناشر</label>
            <input type="text" id="publisher">
            <div class="shortcut-row"><button class="btn-short" onclick="document.getElementById('publisher').value='د.ن'">د.ن</button></div>
        </div>
        <div class="form-group">
            <label>التاريخ</label>
            <input type="text" id="date">
            <div class="shortcut-row"><button class="btn-short" onclick="document.getElementById('date').value='د.ت'">د.ت</button></div>
        </div>
        <div class="form-group">
            <label>اسم مكتبتك</label>
            <input type="text" id="lib_name">
        </div>
    </div>

    <div class="grid-row">
        <div class="form-group" style="grid-column: span 4;">
            <label>رؤوس الموضوعات (قائمة شعبان خليفة)</label>
            <textarea id="subjects"></textarea>
        </div>
    </div>

    <button id="saveBtn" class="btn-submit">حفظ ونشر فوري في الفهرس</button>
    <div id="status"></div>
</div>

<script>
    document.getElementById('saveBtn').addEventListener('click', async () => {
        const token = document.getElementById('gh_token').value;
        const status = document.getElementById('status');
        
        if (!token) {
            alert('يرجى إدخال التوكن للحفظ');
            return;
        }

        const bookData = {
            isbn: document.getElementById('isbn').value,
            title: document.getElementById('title').value,
            author: document.getElementById('author').value,
            publisher: document.getElementById('publisher').value,
            date: document.getElementById('date').value,
            subjects: document.getElementById('subjects').value,
            library: document.getElementById('lib_name').value,
            timestamp: new Date().toISOString()
        };

        const fileName = (bookData.isbn || 'book-' + Date.now()) + '.json';
        const path = `records/${fileName}`;
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(bookData, null, 2))));

        status.style.display = 'block';
        status.innerText = 'جاري الحفظ...';
        status.style.backgroundColor = '#d1ecf1';

        try {
            const response = await fetch(`https://api.github.com/repos/sidiqbens-cmd/LUC-Database/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `إضافة كتاب: ${bookData.title}`,
                    content: content
                })
            });

            if (response.ok) {
                status.innerText = '✅ تم الحفظ بنجاح!';
                status.style.backgroundColor = '#d4edda';
                setTimeout(() => location.reload(), 2000);
            } else {
                status.innerText = '❌ خطأ في التوكن أو الاتصال';
                status.style.backgroundColor = '#f8d7da';
            }
        } catch (e) {
            status.innerText = '❌ فشل الاتصال بالخادم';
        }
    });
</script>

</body>
</html>
