// استبدل دالة saveRecord بهذه النسخة الاحترافية لمعالجة التكرار
async function saveRecord() {
    const token = localStorage.getItem('LUC_T');
    const title = document.getElementById('title').value;
    const isbn = document.getElementById('isbn').value.trim().replace(/[-\s]/g, "");
    const fileName = isbn + ".json";
    
    if(!token || !title) return alert("البيانات ناقصة!");

    const record = { 
        bib: { 
            title: title, 
            author: document.getElementById('author').value, 
            isbn: isbn,
            publisher: document.getElementById('pub').value,
            date: document.getElementById('date').value
        }, 
        holdings: { 
            library: localStorage.getItem('LUC_L'), 
            timestamp: new Date().toISOString() 
        } 
    };

    const content = btoa(unescape(encodeURIComponent(JSON.stringify(record, null, 2))));
    
    let sha = "";
    try {
        // الخطوة 1: فحص وجود الملف لجلب رمز الـ SHA لمنع "فشل الحفظ"
        const checkRes = await fetch(`https://api.github.com/repos/sidiqbens-cmd/LUC-Database/contents/records/${fileName}`, {
            headers: { 'Authorization': `token ${token}` }
        });
        if(checkRes.ok) {
            const fileData = await checkRes.json();
            sha = fileData.sha; 
        }
    } catch(e) {}

    // الخطوة 2: الحفظ أو التحديث التلقائي
    const res = await fetch(`https://api.github.com/repos/sidiqbens-cmd/LUC-Database/contents/records/${fileName}`, {
        method: 'PUT',
        headers: { 'Authorization': `token ${token}` },
        body: JSON.stringify({ 
            message: sha ? `تحديث سجل: ${title}` : `إضافة سجل جديد: ${title}`, 
            content: content,
            sha: sha 
        })
    });

    if(res.ok) {
        alert(sha ? "✅ تم تحديث السجل الموجود بنجاح" : "✅ تم حفظ السجل الجديد بنجاح");
    } else {
        alert("❌ فشل الحفظ: تأكد من صلاحيات التوكن (خيار repo)");
    }
}
