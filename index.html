// استبدل دالة saveRecord بهذه النسخة لتعالج "فشل الحفظ"
async function saveRecord() {
    const token = localStorage.getItem('LUC_T');
    const title = document.getElementById('title').value;
    const isbn = document.getElementById('isbn').value.trim().replace(/[-\s]/g, "");
    const fileName = isbn + ".json";
    
    if(!token || !title) return alert("البيانات ناقصة!");

    const record = { 
        bib: { title, author: document.getElementById('author').value, isbn: isbn }, 
        holdings: { library: localStorage.getItem('LUC_L'), timestamp: new Date().toISOString() } 
    };

    const content = btoa(unescape(encodeURIComponent(JSON.stringify(record, null, 2))));
    
    // 1. أولاً نحاول معرفة إذا كان الملف موجوداً لجلب الـ SHA (لتجنب فشل الحفظ)
    let sha = "";
    try {
        const checkRes = await fetch(`https://api.github.com/repos/sidiqbens-cmd/LUC-Database/contents/records/${fileName}`, {
            headers: { 'Authorization': `token ${token}` }
        });
        if(checkRes.ok) {
            const fileData = await checkRes.json();
            sha = fileData.sha; // جلب رمز التحديث
        }
    } catch(e) {}

    // 2. الآن نقوم بالحفظ (إما إنشاء جديد أو تحديث الموجود)
    const res = await fetch(`https://api.github.com/repos/sidiqbens-cmd/LUC-Database/contents/records/${fileName}`, {
        method: 'PUT',
        headers: { 'Authorization': `token ${token}` },
        body: JSON.stringify({ 
            message: sha ? `Update: ${title}` : `Add: ${title}`, 
            content: content,
            sha: sha // إذا كان موجوداً سيتم التحديث بدلاً من الفشل
        })
    });

    if(res.ok) {
        alert("✅ تم الحفظ بنجاح (تم التحديث إذا كان مكرراً)");
    } else {
        alert("❌ فشل الحفظ: تأكد من صلاحيات التوكن (الخيار repo)");
    }
}
