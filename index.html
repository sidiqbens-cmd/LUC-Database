<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ - LUC</title>
    <style>
        :root { --birzeit: #8e1519; --primary: #2c3e50; --success: #27ae60; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; margin: 0; padding: 5px; font-size: 11px; overflow: hidden; }
        .container { max-width: 1100px; margin: auto; background: #fff; padding: 10px; border-radius: 4px; height: 98vh; display: flex; flex-direction: column; border: 1px solid #ccc; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--birzeit); padding-bottom: 5px; margin-bottom: 8px; }
        .grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-bottom: 4px; }
        .f-group { display: flex; flex-direction: column; }
        .span-2 { grid-column: span 2; } .span-3 { grid-column: span 3; } .span-4 { grid-column: span 4; }
        label { font-weight: bold; color: var(--primary); font-size: 10px; margin-bottom: 1px; }
        input { padding: 3px; border: 1px solid #bbb; border-radius: 3px; font-size: 11px; height: 18px; }
        .search-area { background: #f8f9fa; padding: 6px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 6px; }
        .btn-fetch { background: var(--birzeit); color: white; border: none; cursor: pointer; padding: 4px 10px; border-radius: 3px; font-weight: bold; }
        .btn-ext { background: #5d6d7e; color: white; border: none; padding: 2px 6px; border-radius: 2px; cursor: pointer; font-size: 9px; margin-left: 3px; }
        .btn-save { background: var(--success); color: white; border: none; padding: 10px; width: 100%; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: auto; font-size: 14px; }
        #status { text-align: center; padding: 4px; margin-bottom: 4px; font-weight: bold; display: none; font-size: 10px; border-radius: 3px; }
        .match { background: #f9ebea; color: #a93226; border: 1px solid #e6b0aa; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0; font-size: 16px; color: var(--birzeit);">Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ <small style="font-size: 9px; color:#666;">(Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¶Ø§Ù‡Ø§Ø© Ù…Ø¹ Ø¨ÙŠØ±Ø²ÙŠØª ÙˆØ§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©)</small></h2>
        <div>
            <button class="btn-ext" style="background:#8e1519" onclick="externalSearch('birzeit')">ÙÙ‡Ø±Ø³ Ø¨ÙŠØ±Ø²ÙŠØª</button>
            <button class="btn-ext" style="background:#2874a6" onclick="externalSearch('mandumah')">Ø¯Ø§Ø± Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©</button>
            <button onclick="setToken()" style="cursor:pointer; border:none; background:none;">âš™ï¸</button>
        </div>
    </div>

    <div id="status"></div>

    <div class="search-area">
        <div class="grid">
            <div class="f-group span-4">
                <label>Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ù…Ø¶Ø§Ù‡Ø§Ø© (Ø±Ø¯Ù…Ùƒ Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù†)</label>
                <div style="display:flex; gap:4px;">
                    <input type="text" id="search_query" style="flex-grow:1; height: 22px;" placeholder="Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø¶Ø§Ù‡Ø§Ø©...">
                    <button class="btn-fetch" onclick="smartSearch()">ğŸ” ÙØ­Øµ ÙˆØ¬Ù„Ø¨</button>
                </div>
            </div>
            <div class="f-group span-2">
                <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¶Ø§Ù‡Ø§Ø©</label>
                <input type="text" id="match_status" readonly style="background:#eee; color:red; font-weight:bold;">
            </div>
        </div>
    </div>

    <div class="grid">
        <div class="f-group span-3"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (245a)</label><input type="text" id="title" style="border-color:var(--birzeit)"></div>
        <div class="f-group span-3"><label>Ø§Ù„Ù…Ø¤Ù„Ù (100)</label><input type="text" id="author"></div>
    </div>

    <div class="grid">
        <div class="f-group span-2"><label>Ø¨ÙŠØ§Ù† Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© (245c)</label><input type="text" id="responsibility"></div>
        <div class="f-group span-2"><label>Ø§Ù„Ù†Ø§Ø´Ø± (260b)</label><input type="text" id="publisher"></div>
        <div class="f-group"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="text" id="date"></div>
        <div class="f-group"><label>Ø§Ù„Ù…ÙƒØ§Ù†</label><input type="text" id="place"></div>
    </div>

    <div class="grid">
        <div class="f-group"><label>Ø¯ÙŠÙˆÙŠ (082)</label><input type="text" id="ddc"></div>
        <div class="f-group"><label>Ø§Ù„ÙƒÙˆÙ†Ø¬Ø±Ø³</label><input type="text" id="lcc"></div>
        <div class="f-group"><label>Ø§Ù„ØµÙØ­Ø§Øª</label><input type="text" id="pages"></div>
        <div class="f-group span-3"><label>Ø±Ø¤ÙˆØ³ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª (650)</label><input type="text" id="subjects"></div>
    </div>

    <div class="grid" style="border-top: 1px solid #eee; padding-top: 5px;">
        <div class="f-group span-2"><label>Ù…ÙƒØªØ¨ØªÙƒ</label><input type="text" id="lib_name" readonly></div>
        <div class="f-group"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®</label><input type="number" id="copies" value="1"></div>
        <div class="f-group span-3"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø¬Ù„</label><input type="text" id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></div>
    </div>

    <button class="btn-save" onclick="saveRecord()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù…ÙˆØ­Ø¯</button>
</div>

<script>
    const REPO = "sidiqbens-cmd/LUC-Database";

    function setToken() {
        const t = prompt("GitHub Token:");
        const l = prompt("Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø©:");
        if(t) localStorage.setItem('LUC_TOKEN', t.trim());
        if(l) localStorage.setItem('LUC_LIB', l.trim());
        location.reload();
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('lib_name').value = localStorage.getItem('LUC_LIB') || "Ù…ÙƒØªØ¨Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙØ©";
    });

    function externalSearch(type) {
        const q = document.getElementById('search_query').value;
        if(!q) return alert("Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù†Ø§Ù‹ Ù„Ù„Ø¨Ø­Ø«");
        let url = type === 'birzeit' 
            ? `https://lib.birzeit.edu/search/query?term_1=${q}` 
            : `https://search.mandumah.com/Search/Results?lookfor=${q}`;
        window.open(url, '_blank');
    }

    async function smartSearch() {
        const query = document.getElementById('search_query').value.trim();
        const token = localStorage.getItem('LUC_TOKEN');
        const status = document.getElementById('status');
        if(!query || !token) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

        status.style.display = "block";
        status.style.background = "#eaf2f8";
        status.innerText = "â³ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø¶Ø§Ù‡Ø§Ø© ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯...";

        try {
            const cleanQuery = query.replace(/[-\s]/g, "").toLowerCase();
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/records`, {
                headers: { 'Authorization': `token ${token}` }, cache: "no-store"
            });

            if (res.ok) {
                const files = await res.json();
                const match = files.find(f => f.name.toLowerCase().includes(cleanQuery));
                if (match) {
                    const detail = await (await fetch(match.download_url)).json();
                    status.className = "match";
                    status.innerText = "âš ï¸ Ù…Ø¶Ø§Ù‡Ø§Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©! ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯ØªÙ†Ø§.";
                    document.getElementById('match_status').value = "Ø³Ø¬Ù„ Ù…ÙƒØ±Ø±";
                    fillForm(detail.bib);
                    return;
                }
            }
            
            // Ø¬Ù„Ø¨ Ø£ÙˆÙ„ÙŠ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙØªÙˆØ­Ø© Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…ÙÙ‡Ø±Ø³
            status.innerText = "ğŸŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
            const openRes = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=1`);
            const openData = await openRes.json();
            if(openData.docs.length > 0) fillForm({
                title: openData.docs[0].title,
                author: openData.docs[0].author_name?.[0],
                publisher: openData.docs[0].publisher?.[0],
                date: openData.docs[0].publish_year?.[0]
            });
            
            status.innerText = "âœ… Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙƒØ±Ø± Ù…Ø­Ù„ÙŠ. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
            document.getElementById('match_status').value = "Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯";

        } catch (e) { status.innerText = "âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„."; }
    }

    function fillForm(b) {
        document.getElementById('title').value = b.title || "";
        document.getElementById('author').value = b.author || "";
        document.getElementById('publisher').value = b.publisher || "";
        document.getElementById('date').value = b.date || "";
    }

    async function saveRecord() {
        const token = localStorage.getItem('LUC_TOKEN');
        const title = document.getElementById('title').value;
        if(!token || !title) return alert("Ù†Ù‚Øµ Ø¨ÙŠØ§Ù†Ø§Øª!");

        const isbn = document.getElementById('search_query').value.trim().replace(/[-\s]/g, "") || Date.now();
        const record = {
            bib: { title, author: document.getElementById('author').value, publisher: document.getElementById('publisher').value, date: document.getElementById('date').value },
            holdings: { library: localStorage.getItem('LUC_LIB'), copies: document.getElementById('copies').value }
        };

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(record, null, 2))));
        try {
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/records/${isbn}.json`, {
                method: 'PUT', headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: `Add: ${title}`, content: content })
            });
            if(res.ok) alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!");
        } catch (e) { alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸."); }
    }
</script>
</body>
</html>
