<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ - LUC</title>
    <style>
        :root { --primary: #1a5276; --success: #27ae60; --error: #c0392b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f3f4; margin: 0; padding: 5px; font-size: 13px; overflow: hidden; }
        .container { max-width: 1100px; margin: auto; background: #fff; padding: 10px; border-radius: 5px; height: 98vh; display: flex; flex-direction: column; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 5px; margin-bottom: 10px; }
        .search-area { background: #e8ecef; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #d5dbdb; }
        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; margin-bottom: 5px; }
        .span-4 { grid-column: span 4; } .span-2 { grid-column: span 2; }
        label { font-weight: bold; color: var(--primary); font-size: 11px; }
        input { padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; height: 24px; }
        .btn { cursor: pointer; border: none; border-radius: 3px; font-weight: bold; color: white; padding: 5px 15px; }
        .btn-check { background: #f39c12; } .btn-save { background: var(--success); font-size: 16px; padding: 10px; margin-top: auto; }
        #status_display { font-weight: bold; text-align: center; border-radius: 3px; padding: 5px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0;">Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</h2>
        <div>
            <span id="lib_info" style="font-weight:bold; margin-left:10px;"></span>
            <button onclick="setup()" class="btn" style="background:#7f8c8d;">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
    </div>

    <div class="search-area">
        <div class="grid">
            <div class="f-group span-4">
                <label>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø¯Ù…Ùƒ Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ù…Ø¶Ø§Ù‡Ø§Ø©</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="query" style="flex-grow:1;" placeholder="Ù…Ø«Ø§Ù„: 9789959...">
                    <button onclick="runMatch()" class="btn btn-check">ğŸ” ÙØ­Øµ Ø§Ù„Ù…Ø¶Ø§Ù‡Ø§Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
                </div>
            </div>
            <div class="f-group span-4">
                <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
                <div id="status_display">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            </div>
        </div>
    </div>

    <div class="grid">
        <div class="f-group span-4"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (245)</label><input type="text" id="f_title" style="border: 1px solid var(--primary);"></div>
        <div class="f-group span-2"><label>Ø§Ù„Ù…Ø¤Ù„Ù (100)</label><input type="text" id="f_author"></div>
        <div class="f-group span-2"><label>Ø§Ù„Ø±Ø¯Ù…Ùƒ (020)</label><input type="text" id="f_isbn"></div>
    </div>

    <div class="grid">
        <div class="f-group span-2"><label>Ø§Ù„Ù†Ø§Ø´Ø±</label><input type="text" id="f_pub"></div>
        <div class="f-group span-2"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±</label><input type="text" id="f_date"></div>
        <div class="f-group span-2"><label>Ø¯ÙŠÙˆÙŠ</label><input type="text" id="f_ddc"></div>
        <div class="f-group span-2"><label>Ø§Ù„Ù†Ø³Ø®</label><input type="number" id="f_copies" value="1"></div>
    </div>

    <div class="grid" style="margin-top:10px;">
        <div class="f-group span-8"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø¬Ù„</label><input type="text" id="f_notes" placeholder="..."></div>
    </div>

    <button onclick="saveToRepo()" class="btn btn-save">Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
</div>

<script>
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© - ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø·Ø§Ø¨Ù‚ØªÙ‡Ø§ Ù„Ø­Ø³Ø§Ø¨Ùƒ
    const CONFIG = {
        owner: "sidiqbens-cmd",
        repo: "LUC-Database",
        path: "records" // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø· ÙÙŠ GitHub
    };

    function setup() {
        const t = prompt("Ø£Ø¯Ø®Ù„ GitHub Token:");
        const l = prompt("Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø©:");
        if(t) localStorage.setItem('LUC_T', t.trim());
        if(l) localStorage.setItem('LUC_L', l.trim());
        location.reload();
    }

    window.onload = () => {
        document.getElementById('lib_info').innerText = "ğŸ“ " + (localStorage.getItem('LUC_L') || "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶Ø¨Ø·");
    };

    async function runMatch() {
        const q = document.getElementById('query').value.trim().toLowerCase();
        const token = localStorage.getItem('LUC_T');
        const status = document.getElementById('status_display');

        if(!q || !token) { alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ ÙˆØ§Ù„ØªÙˆÙƒÙ†"); return; }

        status.innerText = "â³ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹...";
        status.style.background = "#fff3cd";

        try {
            // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† GitHub
            const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
                headers: { 'Authorization': `token ${token}` }
            });

            if(response.status === 404) {
                status.innerText = "âŒ Ø®Ø·Ø£: Ø§Ù„Ù…Ø¬Ù„Ø¯ 'records' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!";
                status.style.background = "#f8d7da";
                return;
            }

            const files = await response.json();
            // Ù…Ø¶Ø§Ù‡Ø§Ø© Ø°ÙƒÙŠØ©: ÙŠØ¨Ø­Ø« ÙÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¹Ù† Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            const match = files.find(f => f.name.toLowerCase().includes(q.replace(/[-\s]/g, "")));

            if(match) {
                status.innerText = "âš ï¸ Ù…ÙƒØ±Ø±: Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹!";
                status.style.background = "#f8d7da";
                status.style.color = "#721c24";
                
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙƒØ±Ø± Ù„ØªØ¹Ø¨Ø¦ØªÙ‡Ø§
                const dataRaw = await fetch(match.download_url);
                const data = await dataRaw.json();
                fillFields(data);
            } else {
                status.innerText = "âœ… Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¶Ø§Ù‡Ø§Ø©.";
                status.style.background = "#d4edda";
                status.style.color = "#155724";
            }
        } catch (e) {
            status.innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† Ø£Ùˆ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
            status.style.background = "#f8d7da";
        }
    }

    function fillFields(data) {
        const b = data.bib || data;
        document.getElementById('f_title').value = b.title || "";
        document.getElementById('f_author').value = b.author || "";
        document.getElementById('f_isbn').value = b.isbn || "";
        document.getElementById('f_pub').value = b.publisher || "";
        document.getElementById('f_date').value = b.date || "";
    }

    async function saveToRepo() {
        const token = localStorage.getItem('LUC_T');
        const title = document.getElementById('f_title').value;
        const isbn = document.getElementById('f_isbn').value.replace(/[-\s]/g, "") || "LUC-" + Date.now();
        
        if(!token || !title) { alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©"); return; }

        const record = {
            bib: { title, author: document.getElementById('f_author').value, isbn, publisher: document.getElementById('f_pub').value, date: document.getElementById('f_date').value },
            holdings: { library: localStorage.getItem('LUC_L'), date_added: new Date().toLocaleDateString() }
        };

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(record, null, 2))));
        
        try {
            const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}/${isbn}.json`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: `Add record: ${title}`, content: content })
            });
            if(res.ok) alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!");
            else alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: Ø±Ø¨Ù…Ø§ Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø§Ù„ØªÙˆÙƒÙ† Ø¶Ø¹ÙŠÙ.");
        } catch (e) { alert("âŒ Ø®Ø·Ø£ Ø´Ø¨ÙƒØ©."); }
    }
</script>
</body>
</html>
